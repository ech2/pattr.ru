---
layout:     blogpost
title:      "Питчшифтинг в PureData"
date:       2011-07-16 15:36:30
categories: blog
author:     "Bruce Lee, OSCII"
permalink:  /pitch-shifting-in-pd.html
alias:      /blog/sobiraem-pitchshifter-v-puredata
---

<p>
  <strong>Pitchshifting </strong>- это изменение частоты звука. Его можно встретить в реальном мире, когда источник
  звука приближается/удаляется от слушателя: наверное, каждый замечал, как меняется звук &laquo;гудка&raquo;
  прибывающего поезда. Это явление называется эффектом Доплера. Чтобы понять, в чем он заключается, взгляните на
  картинку:</p>
<p><img alt="" src="https://cloud.githubusercontent.com/assets/1007225/4955831/fda851d8-6697-11e4-8ad4-7b205107ed15.jpg"/></p>

<p>
  В ней машина движется к наблюдател <strong>B</strong>. Для этого наблюдателя частота сирены будет выше,
  потому что машина как бы &laquo;догоняет&raquo; волны. Соответственно для наблюдателя
  <strong>А</strong> частота будет ниже, так как машина удаляется от своих волн. И как же можно
  применить эти знания на практике? Очень просто: динамично меняя задержку. То есть, постоянно увеличивая задержку,
  мы эмулируем отдаление источника звука, и наоборот, бесконечно уменьшая задержку, мы эмулируем приближение.</p>

<h2>Реализация в PureData</h2>

<p>
  Итак, с теорией разобрались, перейдем к практике. Задержка в пд реализуется с помощью объектов <b>delwrite~</b> и <b>vd~</b>.
  Первый из них записывает сигнал в буфер, а второй считывает его. Эти объекты имеют два аргумента: имя буфера и время
  задержки. Соответственно, чтобы объект <b>vd~</b> считывал сигнал из определенного буфера <b>delwrite~</b>, нужно дать
  объектам одинаковые имена. Плюс ко всему, объекту <b>delwrite~</b> нужно обязательно задать второй аргумент, который
  определяет размер буфера задержки. В <b>vd~</b> время задержки указывать не надо, так как мы будем изменять ее с
  помощью другого сигнала.</p>

<p>
  Создаём <b>[delwrite~ <i>pitch 5000</i>]</b> и <b>[vd~ <i>pitch</i>]</b>. В <b>delwrite~</b> будет поступать сигнал,
  высоту тона которого требуется изменить, а из vd~ будет выходить уже измененный сигнал. Время задержки мы будем
  постоянно менять при помощи уже знакомого по статье о гранулярном синтезе объекта <b>phasor~</b>.</p>
<p>
  Перед тем как продолжить, давайте еще раз представим реальную машину; она приближается к нам и, проехав мимо, едет
  дальше. То есть питч сначала растёт, а потом падает. Попробуем симулировать ситуацию, когда машина всё время движется
  от нас. Допустим, мы услышали вой сирены, когда машина была рядом с нами, затем она переместилась расстояние <i>33&nbsp;</i>метра
  (эта цифра взята не с потолка, так удобнее считать, учитывая, что скорость распространения звука равна <i>330 м/с</i>;
  получается, задержка равна <i>0.1 с = 100 мс</i>, а сто &mdash; число круглое). Вот она, рядом с нами, затем
  удаляется, но нельзя допустить, чтобы она удалялась бесконечно, нужно чтобы она мгновенно переместилась к нам, затем
  снова отдалилась, и так до бесконечности.</p>
<p>
  Вот здесь-то нам и нужен <b>phasor~</b>. Зададим ему частоту, например, <i>1Hz</i>, умножим выход фазора на <i>100&nbsp;</i>и
  присоединим полученное к <b>[vd~ <i>pitch</i>]</b>. Что получается? Напомним, что сигнал <b>phasor~</b> - это
  пилообразное колебание <i>0&hellip;1</i>, значит, умножив его на <i>100</i>, получаем диапазон <i>0&hellip;100</i>. В
  результате задержка меняется от <i>0</i> до <i>100 мс</i> за интервал времени, равный <i>1</i> секунде. Это означает,
  что машина от нас удаляется со скоростью <i>33 м/1 с = 33 м/с</i>. Питч понижается. Увеличивая частоту фазора до <i>4
  hz</i>, мы увеличиваем скорость воображаемой машины в четыре раза: <i>33 м/0.25 с = 132 м/с</i>. Питч ещё сильнее
  понизился. Для того чтоб &ldquo;машина&rdquo; приближалась (и соответственно тон повысился), Нужно задать фазору
  отрицательную частоту, в этом случае, он будет генерировать нисходящую пилу диапазоном <i>1&hellip;0</i>. На следующей
  картинке роль источника звука выполняет <b>[osc~ <i>220</i>]</b>, синусоида <i>200&nbsp;Hz</i>.</p>
<p>
  Примечание: слайдер, регулирующий питч умножается на <i>-1</i>. Это необязательно, просто так удобнее, когда границы
  слайдера установлены <i>-10&hellip;10</i>. Получается, когда задаётся отрицательное значение (слайдер влево), то <i>-10
  * -1 = 10</i>, значит в <b>phasor~</b> будет положительное значение частоты, что будет понижать питч; грубо говоря,
  слайдер влево &mdash; питч понизился, слайдер вправо &mdash; повысился.</p>

<p><img alt="" src="https://cloud.githubusercontent.com/assets/1007225/4955830/fda39b16-6697-11e4-94ac-bd6873b722cd.png"/></p>

<p>
  Однако, и тут будут возникать те же проблемы, что и в гранулярном синтезаторе. Имеется в виду треск, возникающий при
  резком скачке сигнала фазора. Для устранения этой проблемы делаем также, как и в прошлом случае: пропускаем сигнал
  фазора через цепочку преобразований <b>[phasor~] </b>=&gt; <b>[-~ <i>0.5</i>]</b> =&gt; <b>[ *~ <i>0.5</i>]</b> =&gt;
  <b>[cos~]</b>. Полученное используем, как огибающую громкости. Теперь, для заполнения пустых мест, создаём второй <b>[vd~
  <i>pitch</i>]</b> задержкой которого будет рулить та же пила, только смещенная на пол фазы. Аналогично, как и в
  гранулярном синте.</p>

<p>Итоговый результат выглядит так:</p>

<p><img alt="" src="https://cloud.githubusercontent.com/assets/1007225/4955833/fdaae268-6697-11e4-9399-bbf75f4c5e34.png"/></p>
<p>
  Вот и все. Добавим лишь только немного более удобный контроль, чтобы можно было бы изменять питч в полутонах.
  Вычислить его можно по следующей формуле:</p>

<p><img alt="" src="https://cloud.githubusercontent.com/assets/1007225/4955835/fdb00248-6697-11e4-8be5-f58041378f0d.png" style="width: 348px; height: 100px;"/></p>
<p>
  В ней <b>P</b> &ndash; изменение высоты звука в полутонах; <b>sr </b>&ndash; частота дискретизации; <b>win</b> &ndash;
  размер окна в миллисекундах.</p>
<p>
  Эта же формула, только собранная в Pd:</p>

<p><img alt="" src="https://cloud.githubusercontent.com/assets/1007225/4955834/fdafd3c2-6697-11e4-9a3f-9b6fc8805f2d.png"/></p>
<p>
  Выход регулирует частоту <b>phasor~</b>.</p>
<p>
  На этом всё. Happy patching! :)</p>