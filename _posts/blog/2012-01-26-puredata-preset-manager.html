---
layout:     blogpost
title:      "Создаем Менеджер Пресетов в PureData"
date:       2012-01-26 04:48:52
categories: blog
author:     "OSCII"
permalink:  /puredata-preset-manager.html
alias:      /blog/sozdaem-menedzher-presetov-v-puredata
---

<p>Да, <em>Max</em> более совершенен, чем <em>Pd</em>. Да, в&nbsp;нем очень много сделано для продуктивной работы.
  Наконец, его интерфейс не&nbsp;тормозит при большом количестве объектов в&nbsp;патче. Однако, есть в&nbsp;<em>Pd</em>
  что-то магическое, что заставляет снова и&nbsp;снова открывать этот простой интерфейс, написанный
  на&nbsp;<em>tcl/tk</em>, с&nbsp;его простенькими боксами и&nbsp;радующей ночью глаза цветовой гаммой. Может это и&nbsp;есть
  та&nbsp;самая магия open source, которая заставляет людей использовать gentoo на&nbsp;десктопе?</p>

<p>В&nbsp;данной статье мы&nbsp;будем пытаться решить одну наболевшую тему всех пользователей этой замечательной
  программы, а&nbsp;именно, сохранение параметров числовых боксов, слайдеров, кнобов и&nbsp;т.д. Казалось&nbsp;бы, очень
  важная функция, почему до&nbsp;сих пор нет специального объекта, аналогичного <strong>preset</strong>
  в&nbsp;<em>Max</em>? Все дело в&nbsp;том, что с&nbsp;помощью <em>PureData API</em> нельзя получить доступ к&nbsp;данным
  других объектов, поэтому приходится выкручиваться.</p>

<p>Разумеется, были попытки реализации пресетов. Я&nbsp;посмотрел некоторые из&nbsp;них, но&nbsp;их&nbsp;реализация мне
  показалась сложной (да, я&nbsp;в&nbsp;них до&nbsp;конца не&nbsp;разобрался)&nbsp;&mdash; мне&nbsp;же хотелось чего-то
  легковесного и&nbsp;гибкого. В&nbsp;результате, после дня раздумий и&nbsp;вечера патчинга родилась такая система.</p>
<h2>Постановка задачи</h2>
<p>Для сохранения пресетов нам нужно:</p>
<ol>
  <li>постоянно следить за&nbsp;сохраняемыми параметрами;</li>
  <li>иметь возможность в&nbsp;любой момент извлечь и&nbsp;сохранить&nbsp;их;</li>
  <li>иметь возможность восстановить состояние объектов из&nbsp;сохраненных данных.</li>
</ol>
<p>Мне сразу вспомнились объекты <strong>pattr</strong> и&nbsp;<strong>pattrstorage</strong> из&nbsp;макса. Первый
  соединяется с&nbsp;gui объектом, значение которого надо сохранить, а&nbsp;второй является хранилищем данных. Было
  решено сделать что-то похожее.</p>
<h2>Представляем, как все будет</h2>
<p>Итак, наш &laquo;аналог&raquo; объекта <strong>pattr</strong> будет следить за&nbsp;параметром, а&nbsp;аналог
  <strong>pattrstorage</strong>&rsquo;а будет при необходимости опрашивать его и&nbsp;сохранять значения. Назовем эти
  объекты <strong>store</strong> и&nbsp;<strong>storage</strong> соответственно. Все это должно выглядеть примерно так:
</p>

<p><img src="/img/pd-preset/1.png" alt="Presets PureData. Представляем, как все будет"/></p>

<p>Объект <strong>store</strong> будет хранить текущее, а&nbsp;также присваивать новое значение числовому боксу. Именно
  поэтому эти объекты соединены между собой таким образом. С&nbsp;помощью сообщения <em>&laquo;save&raquo;</em> <strong>storage</strong>
  будет посылать команду в&nbsp;<strong>store</strong>, чтобы тот отправил ему текущее значение числового бокса.
  <em>&laquo;recall&raquo;</em>&nbsp;же будет делать обратное&nbsp;&mdash; задавать боксу новое значение.</p>

<p>Итак, общий вид понятен, двигаемся дальше.</p>

<h2>Делаем основу</h2>

<p>В&nbsp;максе информация пресетов хранится в&nbsp;<a href="http://ru.wikipedia.org/wiki/JSON"
                                                       alt="Статья о JSON на википедии">json</a> формате. Теоретически,
  <em>Pd</em>&nbsp;может работать с&nbsp;ним через библиотеку <a
      href="http://puredata.info/community/projects/software/purest-json"
      alt="PuREST - библиотека для работы с RESTful сервисами и JSON данными из PureData">PuREST</a>, но&nbsp;он&nbsp;заточен
  под онлайн сервисы, да&nbsp;и&nbsp;зачем все усложнять? Легче всего записать данные в .txt файл с&nbsp;помощью объекта
  <strong>textfile</strong>. Он&nbsp;может сохранять любое количество сообщений и&nbsp;последовательно выводить&nbsp;их.
  Подробнее о&nbsp;том, как он&nbsp;работает, можно прочитать в&nbsp;хелпе, а&nbsp;сейчас приступим к&nbsp;созданию
  объектов.</p>

<p><img src="/img/pd-preset/2.png" alt="Presets PureData. Первые наброски."/></p>

<p>На&nbsp;картинке выше сделан скрин с&nbsp;комментариями трех открытых патчей. <strong>root&nbsp;</strong>&mdash; это
  тестовый патч, в&nbsp;котором мы&nbsp;будем проверять работу <strong>store </strong>и&nbsp;<strong>storage</strong>. В&nbsp;прицнипе,
  на&nbsp;данном этапе уже можно сохранять и&nbsp;восстанавливать значение одного числового бокса. Порядок действий
  таков:</p>
<ol>
  <li>меняем значение числового бокса;</li>
  <li>нажимаем <em>&laquo;get&raquo;</em>&nbsp;&mdash; это очистит <strong>textfile</strong>,<strong> </strong>после
    чего будет послан <em>bang</em>&nbsp;в <strong>[s&nbsp;presetTrigger]</strong>. Получателем этого <em>bang</em>
    будет объект <strong>float</strong>, находящийся<strong> </strong>в&nbsp;<strong>store</strong>, который выведет
    сохраненное число через свой аутлет и&nbsp;направит его снова в&nbsp;<strong>store</strong>, где оно выведется через
    [r&nbsp;presetGetAll]], превратится в&nbsp;сообщение вида <em>&laquo;add %число_из_бокса%&raquo;</em> и&nbsp;отправится
    в&nbsp;<strong>textfile</strong>;
  </li>
  <li>нажимаем <em>&laquo;store&raquo;</em>&nbsp;&mdash; это пошлет в&nbsp;<strong>textfile</strong> сообщение
    <em>&laquo;write&raquo;</em> и&nbsp;создаст в&nbsp;папке с&nbsp;патчем <strong>root</strong> текстовый файл, в&nbsp;котором
    будут содежраться все параметры пресета;
  </li>
  <li>изменим значение числового бокса, после чего жмем &laquo;recall&raquo;&nbsp;&mdash; сохраненное ранее значение
    должно восстановиться.
  </li>
</ol>
<h2>Наращиваем функциональность</h2>
<p>Итак, мы&nbsp;сделали основную часть и&nbsp;успешно проверили работоспособность. Однако, в&nbsp;данный момент можно
  сохранять только один параметр, что не&nbsp;есть гуд. Как мы&nbsp;помним, объекту <strong>pattr</strong> в&nbsp;аргументе
  необходимо задать имя параметра, значение которого будет запоминаться. Таким образом макс индексирует параметры в&nbsp;json
  файле, чтобы впоследствии можно было восстановить данные в&nbsp;нужные gui объекты. Мы&nbsp;сделаем что-то похожее и&nbsp;сделаем
  это хитро. Взглянем на&nbsp;скриншот:</p>

<p><img src="/img/pd-preset/3.png" alt="Presets PureData. Работаем с несколькими числовыми боксами."/></p>

<p>Как видно, в&nbsp;патче <em>root.pd</em> теперь три числовых бокса соединены с&nbsp;тремя объектами <strong>[store
  one]</strong>, <strong>[store two]</strong> и&nbsp;<strong>[store three]</strong>. Каждому сохраняемому параметру дано
  имя. Теперь если покрутить парамтеры боксов и&nbsp;открыть preset.txt, то&nbsp;можно увидеть примерно следующее:</p>
<p>
  <code>
    three&nbsp;67;
    two&nbsp;43;
    one 165;
  </code>
</p>
<p>То&nbsp;есть каждому параметру в&nbsp;файле добавился индекс, соответствующий введенному в&nbsp;объект
  <strong>store</strong> аргументу. Это делается благодаря так называемым <em>аргументам абстракций (abstraction
    creation arguments)</em>. Если внимательно посмотреть в&nbsp;патч <strong>store.pd</strong>, то&nbsp;можно заметить,
  что объекты <strong>route</strong> и&nbsp;<strong>prepend</strong> имеют аргумент
  <em>&laquo;$1&raquo;&nbsp;&mdash; </em>это и&nbsp;есть эти аргументы. Суть в&nbsp;том, что при использовании патча,
  как абстрации, внутри не&nbsp;$1, $2, $3&nbsp;и&nbsp;т.д. заменяются соответственно первым, вторым и&nbsp;третьим
  аргументами. То&nbsp;есть&nbsp;в <strong>[store one]</strong> на&nbsp;самом деле находятся объекты <strong>[route
    one]</strong> и&nbsp;<strong>[prepend one]</strong>.</p>

<p>Теперь о&nbsp;том, для чего, собственно, были добавлены <strong>prepend </strong>и&nbsp;<strong>route</strong>.
  Первый из&nbsp;них перед отправкой параметра в&nbsp;<strong>textfile</strong> создает тот самый индекс, который мы&nbsp;видели
  в&nbsp;текстовом файле, а&nbsp;<strong>route</strong> в&nbsp;отсеивает параметры с&nbsp;не&nbsp;чужими индексами,
  когда все содержание текстового файла транслируются через <strong>[p&nbsp;presetSetParam]</strong>.</p>

<p>Как уже говорилось ранее, при помощи <em>bang</em> можно выводить по&nbsp;одному сообщения
  из&nbsp;<strong>textfile</strong>. При достижении последнего сообщения, объект выводит <em>bang</em> через правый
  аутлет.</p>

<p>Для того, чтобы извлечь все сообщения, надо пройтись по&nbsp;всему файлу, что делает объект <strong>until</strong>.
  Это очень интересный объект, если ему в&nbsp;инлет подать какое-либо число, скажем, <em>десять</em>, то&nbsp;он&nbsp;один
  за&nbsp;другим выведет 10&nbsp;<em>bang-сообщений</em>. Если&nbsp;же на&nbsp;вход подать просто <em>bang</em>, то&nbsp;<strong>until</strong>
  будет генерировать <em>бэнги</em> до&nbsp;тех пор, пока в&nbsp;его правый инлет не&nbsp;поступит <em>bang</em>.</p>

<p>Теперь можно разобраться, что происходит, при нажатии на&nbsp;сообщение <em>&laquo;recall&raquo;</em>. Сначала <em>bang</em>
  поступает в&nbsp;сообщение <em>&laquo;read preset.txt, rewind&raquo;</em>, которое загружает
  в&nbsp;<strong>textfile</strong> файл <em>preset.txt</em>, после чего посылает сообщение <em>&laquo;rewind&raquo;</em>,
  которое делает так, что следующий <em>bang</em>, полученный объектом, выведет первый параметр из&nbsp;файла. Дальше
  <em>bang</em> идет в&nbsp;объект <strong>until</strong>, который генерирует <em>бэнги</em> один за&nbsp;другим и&nbsp;направляет
  их&nbsp;в&nbsp;<strong>textfile</strong> до&nbsp;тех пор, пока последний не&nbsp;выведет <em>bang </em>из&nbsp;своего
  правого аутлета и&nbsp;не&nbsp;остановит <strong>until</strong>.</p>

<p>На&nbsp;данный момент в&nbsp;пресете можно сохранять только числа, но&nbsp;чтобы можно было использовать в&nbsp;реальных
  патчах необходимо добавить, как минимум сохранение списков. Сделаем это, создав аналоги патча <strong>store</strong>
  для остальных типов данных. Переименуем наш <strong>store</strong> в&nbsp;<strong>sfloat</strong> и&nbsp;создадим
  объект <strong>slist</strong>.</p>

<p><img src="/img/pd-preset/4.png" alt="Presets PureData. Сохраняем списки (lists)"/></p>

<p>Это немного измененный патч <strong>sfloat.pd</strong>, адаптированный для списков.</p>

<p>Следующим шагом необходимо добавить возможность сохранения разных пресетов. Обдумывая, как это реализовать, я&nbsp;пришел
  к&nbsp;выводу, что лучше всего сохранять каждый пресет в&nbsp;отдельный файл. В&nbsp;этом случае не&nbsp;придется
  конструировать дополнительную логику, разделяющую строки для разных пресетов в&nbsp;текстовом файле, а&nbsp;чем меньше
  сложность патча&nbsp;&mdash; тем стабильнее будет его работа (ведь одно дело сохранять два-три параметра, а&nbsp;другое,
  когда из&nbsp;будет под сотню).</p>

<p>Итак, для того, чтобы можно было управлять несколькими пресетами, нам надо менять содержимое месседж боксов &laquo;read
  preset.txt&raquo; и&nbsp;&laquo;write preset.txt&raquo;, а&nbsp;именно менять имена файлов для соответствующих
  пресетов. Взглянем на&nbsp;модифицированный <strong>storage.pd</strong>:</p>

<p><img src="/img/pd-preset/5.png" alt="Presets PureData. Реализуем работу с несколькими пресетами."/></p>

<p>Здесь появился новый объект: <strong>makefilename</strong>. Он&nbsp;как раз создан для генерации имен файлов и&nbsp;идеально
  нам подходит. При поступлении числа в&nbsp;инлет, объект выводит сообщение вида <em>&laquo;preset-%i.txt&raquo;</em>,
  заменяя <em>%i</em>&nbsp;числом. Также пришлось вывести &laquo;rewind&raquo; в&nbsp;отдельный месседж бокс, так как я&nbsp;не&nbsp;нашел
  легкого способа сгенерировать сложное сообщение с&nbsp;запятой.</p>

<p>Все, теперь система работает. Теперь добавим удобства, сделав небольшой gui. Откроем storage.pd, нажмем правой
  кнопкой на&nbsp;пустом месте и&nbsp;выберем Properties. В&nbsp;появившемся окне отметим галочку <em>&laquo;Graph on&nbsp;parent&raquo;</em>,
  после этого появится красный прямоугольник в&nbsp;патче. Все объекты интерфейса, как кнопки, числовые боксы и&nbsp;комментарии,
  находящиеся внутри этого прямоугольника будут отображаться в&nbsp;патча а-ля максовский <strong>bpatcher</strong>.
  Размеры и&nbsp;позиция прямоугольника задаются в&nbsp;окне <em>canvas</em> с&nbsp;помощью параметров <em>size</em> и&nbsp;<em>margin</em>.
</p>

<p><img src="/img/pd-preset/6.png" alt="Presets PureData. Делаем GUI."/></p>

<p>Вот так теперь выглядит объект <strong>storage</strong> в&nbsp;патче:</p>

<p><img src="/img/pd-preset/7.png" alt="Presets PureData. Окончательный вариант объекта [storage]."/></p>

<p>Теперь <em>Pd</em>&nbsp;стала немного удобнее :)</p>

<h2>Напоследок</h2>

<p>Данной системе пресетов не&nbsp;хватает сохранения таблиц, но&nbsp;это я&nbsp;отложу на&nbsp;будущее, так как скорее
  всего, чтобы было удобно, потребуется какое-то хитрое колдунство. Также я&nbsp;неплохо было&nbsp;бы добавить в&nbsp;storage
  инлет для внешнего управления пресетами, чтобы можно было подрубить какой-нибудь MIDI&nbsp;контроллер.</p>

<p>Скачать файлы можно из&nbsp;раздела
  &laquo;<a href="/patches/pd-preset.html" alt="Скачать менеджер пресетов PureData">Патчи</a>&raquo;, enjoy!
</p>